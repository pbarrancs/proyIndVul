---
title: "PCA"
author: "Pablo, Román, Sofia"
date: "14/5/2020"
output: html_document
---

```{r setup, include=FALSE, results=FALSE}
#Instalar las librerias necesarias y cargarlas
instalar <- function(paquete) {
    if (!require(paquete,character.only = TRUE,
                 quietly = TRUE, 
                 warn.conflicts = FALSE)){
          install.packages(as.character(paquete),
                           dependecies = TRUE,
                           repos = "http://cran.us.r-project.org")
          library(paquete,
                  character.only = TRUE, 
                  quietly = TRUE,
                  warn.conflicts = FALSE)
    }
}
libs <- c('rgdal', 'factoextra', 'gridExtra','sf', 'ggplot2', 'tmap', 'tmaptools', 'leaflet','dplyr') 
lapply(libs, instalar)
options(scipen=999)
```

```{r}
# Este chung es para la compu de pablo porque con el codigo de arriba no me cargaba las librerias
library('factoextra')
library('gridExtra')
library('sf')
library('ggplot2')
library('tmap')
library('tmaptools')
library('leaflet')
library('dplyr')
```



```{r,echo = FALSE}
df<- read.csv("BD.csv")
df[,5:13]<-df[,5:13]/df[,3]
df[,13]<-df[,13]*1000 #Remuneración en miles de pesos
df[,15]<-df[,15]/100 
df <- df[,-c(1,2,3,4,8,9,10,12,14,15)]
names(df) <- c("X1","X2","X3","X4","X5","X6") #Todas las variables estan en terminos poblacionales
attr(df$X1, "descripcion") <- "Ingresos Inferiores. "
attr(df$X2, "descripcion") <- "Carencia de Alimentos."
attr(df$X3, "descripcion") <- "Carencia de Salud."
attr(df$X4, "descripcion") <- "Personal medico"
attr(df$X5, "descripcion") <- "Remuneracion (miles de pesos)"
attr(df$X6, "descripcion") <- "Promedio años de escolaridad"
#str(df)
head(df)
```
## Calculo de los Componentes Principales

Para calcular los componentes principales, usaremos la matriz de correlación dado que las unidades de nuestras variables son distintas, a pesar de que la mayoria esten en terminos poblacionales.

```{r}
#solo para comparar y para fines graficos
z <- princomp(df,cor = T)
summary(z, loadings=T)
```
Para eso scamos la matriz de correlacion $R$ que es la siguiente.
```{r}
(R <- round(cor(df),3))
```

Ahora para calcular las componentes principales encontraremos sus egienvecores.
```{r}
eig <- eigen(R)
(y <- round(eig$vectors,3)*-1) #lo multiplicamos por -1 simplemente por interpretacion
```


Podemos ver que los componentes principales obtenidos de la matriz de correlación, son los siguientes.
$$\begin{array}{l}
Y_{1} =  0.449X_{1} + 0.371X_{2} + 0.405X_{3} - 0.395X_{4} - 0.380X_{5} - 0.442X_{6}\\
Y_{2} =  0.115X_{1} + 0.308X_{2} + 0.390X_{3} + 0.531X_{4} + 0.618X_{5} - 0.275X_{6}\\
Y_{3} =  0.415X_{1} - 0.813X_{2} + 0.035X_{3} - 0.058X_{4} + 0.200X_{5} - 0.349X_{6}\\
Y_{4} =  0.245X_{1} + 0.309X_{2} - 0.805X_{3} - 0.112X_{4} + 0.251X_{5} - 0.347X_{6}\\
Y_{5} = -0.210X_{1} + 0.042X_{2} + 0.183X_{3} - 0.738X_{4} + 0.598X_{5} + 0.135X_{6} \\
Y_{6} = -0.713X_{1} - 0.097X_{2} + 0.008X_{3} - 0.018X_{4} - 0.113X_{5} - 0.685X_{6}\\
\end{array}$$

## Graficas y Analisis

Haremos la grafica de codo correspondiente, para dererminar cuales son las componentes mas significativas.
Para realizar esto, veremos que tanta varianza aporta cada componente principal, mediante el siguiente razonamiento.

$$\frac{\lambda_{k}}{\lambda_{1} + ... + \lambda_{k}}$$

```{r, echo = FALSE}
aport_var <- function(l)
{
  lsum <- sum(l)
  l/lsum
}
var <- aport_var(eig$values)
names(var) <- c("l1","l2","l3","l4","l5","l6")
plot(var,type="o",ylab = "Porcentaje de varianza expresada", xlab = "Componente")
```


```{r}
fviz_screeplot(z,barfill = "purple",barcolor = "green",linecolor = "red",addlabels =TRUE)
fviz_screeplot(z,geom = "line",linecolor = "red" ,addlabels =TRUE)
```

```{r}
fviz_pca_var(z,col.var="contrib")
```

```{r}
gr1 <- fviz_contrib(z,choice = "var", axes = 1)
gr2 <- fviz_contrib(z,choice = "var", axes = 2)
grid.arrange(gr1, gr2, ncol = 2)
```


```{r}
fviz_pca_ind(z,
             col.ind = "cos2", # Color by the quality of representation
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
```

```{r}
fviz_pca_biplot(z, repel = TRUE,
                col.var = "#2E9FDF", # Variables color
                col.ind = "#696969"  # Individuals color
                )
```

##Índice por delegación

```{r}
indice <- function(df,vec){
  n = length(df[,1])
  ind = c()
  for ( i in 1:n){
    ind[i] = vec[1]*df[i,1] + vec[2]*df[i,2] + vec[3]*df[i,3] + vec[4]*df[i,4] +vec[5]*df[i,5] + vec[6]*df[i,6]
  }
  return(ind)
}
scores <- eig$vectors[,1]
ind <- indice(df,scores)
(ind <- round(100/as.numeric(ind),3))
```

```{r}
nomgeo <- c("Álvaro Obregón", "Azcapotzalco", "Benito Juárez", "Coyoacán", "Cuajimalpa de Morelos", "Cuauhtémoc", "Gustavo A. Madero","Iztacalco","Iztapalapa","La Magdalena Contreras", "Miguel Hidalgo", "Milpa Alta", "Tláhuac", "Tlalpan", "Venustiano Carranza", "Xochimilco")
index <- data.frame(nomgeo,ind)
```


##Semaforo de la ciudad de México

```{r}
mapa<-st_read("alcaldias/alcaldias.shp",stringsAsFactors=FALSE)
str(mapa)
mapa_datos <- inner_join(mapa,index, by="nomgeo")
str(mapa_datos)
```

```{r, echo=FALSE, include=FALSE}
tm_shape(mapa_datos)+
  tm_polygons("ind",id="nomgeo",plette="Reds")
```


```{r}
tmap_mode("view")
tmap_last()
```







